<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Among'sus - Team Collaboration Platform</title>
    <style>
        /* CSS styles are unchanged */
        :root {
            --primary-color: #dc2626; /* Crimson Red */
            --primary-hover: #b91c1c;
            --color-todo: #3b82f6; /* Blue */
            --color-inprogress: #f59e0b; /* Amber */
            --color-done: #10b981; /* Green */
            --background-color: #111827; /* Dark Blue-Gray */
            --surface-color: #1f2937; /* Lighter Gray for cards */
            --border-color: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.2);
            --border-radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--background-color); color: var(--text-primary); min-height: 100vh; line-height: 1.6; }
        .app-container { min-height: 100vh; display: flex; flex-direction: column; }
        .header { background: rgba(31, 41, 55, 0.8); backdrop-filter: blur(10px); padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .logo { display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; font-weight: 700; color: var(--text-primary); cursor: pointer; }
        .logo-icon { width: 32px; height: 32px; background: var(--primary-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; font-weight: bold; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--primary-color); background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 2px solid var(--surface-color); }
        .user-avatar:hover { transform: scale(1.1); box-shadow: 0 0 10px var(--primary-color); }
        .btn { width: 100%; padding: 0.8rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 10px 20px rgba(220, 38, 38, 0.2); }
        .btn-secondary { background: transparent; color: var(--text-secondary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: var(--border-color); color: var(--text-primary); }
        .auth-screen { display: flex; justify-content: center; align-items: center; flex-grow: 1; padding: 2rem; }
        .auth-card { background: var(--surface-color); padding: 2.5rem; border-radius: var(--border-radius); box-shadow: var(--shadow-lg); width: 100%; max-width: 420px; animation: fadeIn 0.5s ease-out; border: 1px solid var(--border-color); }
        .auth-header { text-align: center; margin-bottom: 2rem; }
        .auth-title { font-size: 2rem; font-weight: 800; margin-bottom: 0.5rem; }
        .auth-subtitle { color: var(--text-secondary); }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        .form-input { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; transition: all 0.3s; background: var(--background-color); color: var(--text-primary); }
        .form-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.3); }
        .password-input-wrapper { position: relative; }
        .password-toggle { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem; }
        .auth-switch, .auth-extra-links { text-align: center; margin-top: 1.5rem; color: var(--text-secondary); font-size: 0.9rem; }
        .auth-link { color: var(--primary-color); cursor: pointer; font-weight: 600; text-decoration: none; }
        .auth-link:hover { text-decoration: underline; }
        .main-content { flex: 1; padding: 2rem; max-width: 1400px; margin: 0 auto; width: 100%; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .dashboard-title { font-size: 2.5rem; font-weight: 800; }
        .section-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); }
        .my-tasks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; margin-bottom: 3rem; }
        .projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .project-card { background: var(--surface-color); border-radius: var(--border-radius); padding: 1.5rem; cursor: pointer; transition: all 0.3s; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .project-card:hover { transform: translateY(-5px); box-shadow: 0 0 20px rgba(220, 38, 38, 0.2); border-color: var(--primary-color); }
        .project-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .project-name { font-size: 1.25rem; font-weight: 600; }
        .project-footer { margin-top: auto; }
        .progress-bar { width: 100%; height: 8px; background: var(--background-color); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary-color); transition: width 0.5s ease-in-out; }
        .project-view-controls { display: flex; flex-wrap: wrap; gap: 1rem; }
        .task-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-top: 2rem; }
        .task-column { background: var(--surface-color); border-radius: var(--border-radius); padding: 1rem; }
        #todo .task-column-header { border-top: 4px solid var(--color-todo); }
        #in-progress .task-column-header { border-top: 4px solid var(--color-inprogress); }
        #done .task-column-header { border-top: 4px solid var(--color-done); }
        .task-column-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding: 1rem 0.5rem 0; }
        .column-title { font-weight: 600; font-size: 1.1rem; }
        .task-count { background: var(--background-color); color: var(--text-secondary); padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem; font-weight: bold; }
        .tasks-container { min-height: 100px; }
        .task-card { background: var(--background-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid; cursor: grab; transition: all 0.3s; box-shadow: var(--shadow-sm); }
        .task-card.todo { border-color: var(--color-todo); }
        .task-card.in-progress { border-color: var(--color-inprogress); }
        .task-card.done { border-color: var(--color-done); }
        .task-card.dragging { opacity: 0.5; transform: rotate(3deg); }
        .task-title { font-weight: 600; margin-bottom: 0.5rem; }
        .task-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-secondary); }
        .task-meta .project-name-label { font-size: 0.8rem; padding: 0.2rem 0.5rem; background-color: var(--surface-color); border-radius: 6px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 2000; align-items: center; justify-content: center; padding: 1rem; }
        .modal.show { display: flex; animation: fadeIn 0.3s; }
        .modal-content { background: var(--surface-color); border-radius: var(--border-radius); padding: 2rem; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease-out; border: 1px solid var(--border-color); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .modal-title { font-size: 1.5rem; font-weight: 700; }
        .close-btn { background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--text-secondary); line-height: 1; }
        .profile-pic-section { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem; }
        .avatar-preview { width: 80px; height: 80px; border-radius: 50%; background-color: var(--primary-color); background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; color: white; border: 3px solid var(--border-color); }
        #avatarInput { display: none; } #avatarLabel { cursor: pointer; }
        .team-member-list { list-style: none; }
        .team-member-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); }
        .team-member-item:last-child { border-bottom: none; }
        .team-member-item .member-avatar { margin-left: 0; }
        .team-member-info strong { display: block; }
        .team-member-info span { font-size: 0.9rem; color: var(--text-secondary); }
        .team-member-item .chat-btn { margin-left: auto; }
        #figmaEmbedContainer { width: 100%; aspect-ratio: 16 / 9; background-color: var(--background-color); border-radius: 8px; margin-top: 1.5rem; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); }
        #figmaEmbedContainer iframe { width: 100%; height: 100%; border: none; border-radius: 8px; }
        #secretModal .modal-content pre { background-color: var(--background-color); padding: 1.5rem; border-radius: 8px; color: var(--text-secondary); font-family: 'Courier New', Courier, monospace; white-space: pre-wrap; word-wrap: break-word; font-size: 0.9rem; line-height: 1.8; }
        .notification { position: fixed; bottom: 20px; right: 20px; background: var(--surface-color); padding: 1rem 1.5rem; border-radius: 8px; box-shadow: var(--shadow-lg); z-index: 3000; animation: slideUp 0.4s ease-out; max-width: 320px; border-left: 4px solid; }
        .notification.success { border-color: var(--color-done); } .notification.error { border-color: var(--primary-color); } .notification.info { border-color: var(--color-todo); }
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { .header, .main-content, .auth-screen { padding: 1rem; } .dashboard-header { flex-direction: column; align-items: stretch; text-align: center; } .task-board { grid-template-columns: 1fr; } .dashboard-title { font-size: 2rem; } }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- AUTH SCREENS -->
        <div id="loginScreen" class="auth-screen"></div>
        <div id="registerScreen" class="auth-screen hidden"></div>

        <!-- MAIN APP -->
        <div id="mainApp" class="hidden">
            <header class="header"></header>
            <main class="main-content">
                <div id="dashboard">
                    <div id="dashboard-view">
                        <div class="dashboard-header"><h1 class="dashboard-title">Dashboard</h1><button class="btn btn-primary" id="createProjectBtn">New Project</button></div>
                        <div id="myTasksSection"><h2 class="section-title">My Tasks</h2><div class="my-tasks-grid" id="myTasksGrid"></div></div>
                        <div id="projectsSection"><h2 class="section-title">All Projects</h2><div class="projects-grid" id="projectsGrid"></div></div>
                    </div>
                </div>
                <div id="projectView" class="hidden">
                    <div class="dashboard-header">
                        <div><button class="btn btn-secondary" id="backToProjects" style="width: auto; padding: 0.5rem 1rem; margin-bottom: 1rem;">← Back</button><h1 class="dashboard-title" id="projectTitle"></h1></div>
                        <div class="project-view-controls"><button class="btn btn-secondary" id="viewTeamBtn">Team</button><button class="btn btn-secondary" id="viewFigmaBtn">Designs</button><button class="btn btn-primary" id="createTaskBtn">+ New Task</button></div>
                    </div>
                    <div class="task-board" id="taskBoard">
                        <div class="task-column" id="todo"><div class="task-column-header"><span class="column-title">To Do</span><span class="task-count" id="todoCount">0</span></div><div class="tasks-container" id="todoTasks"></div></div>
                        <div class="task-column" id="in-progress"><div class="task-column-header"><span class="column-title">In Progress</span><span class="task-count" id="inProgressCount">0</span></div><div class="tasks-container" id="inProgressTasks"></div></div>
                        <div class="task-column" id="done"><div class="task-column-header"><span class="column-title">Done</span><span class="task-count" id="doneCount">0</span></div><div class="tasks-container" id="doneTasks"></div></div>
                    </div>
                </div>
            </main>
        </div>

        <!-- MODALS -->
        <div id="profileModal" class="modal"></div> <div id="createProjectModal" class="modal"></div>
        <div id="createTaskModal" class="modal"></div> <div id="teamModal" class="modal"></div>
        <div id="chatModal" class="modal"></div> <div id="figmaModal" class="modal"></div>
        <div id="secretModal" class="modal"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- STATE & ELEMENTS ---
        let currentUser = null, currentProject = null, projects = [], tasks = [];
        const G = {
            loginScreen: document.getElementById('loginScreen'),
            registerScreen: document.getElementById('registerScreen'),
            mainApp: document.getElementById('mainApp'),
            dashboard: document.getElementById('dashboard-view'),
            projectView: document.getElementById('projectView'),
            projectsGrid: document.getElementById('projectsGrid'),
            myTasksGrid: document.getElementById('myTasksGrid'),
            projectTitle: document.getElementById('projectTitle'),
            header: document.querySelector('.header'),
            userAvatar: null,
        };

        // --- INITIALIZATION ---
        function initializeApp() {
            loadAllDynamicHTML();
            setupEventListeners();
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                loadUserData();
                showMainApp();
            } else {
                if (!localStorage.getItem('sampleDataLoaded')) { loadSampleData(); }
                loadUserData();
                showLoginScreen();
            }
        }

        function loadAllDynamicHTML() {
            G.loginScreen.innerHTML = `<div class="auth-card"><div class="auth-header"><div class="logo"><div class="logo-icon">A</div>Among'sus</div><h2 class="auth-title">Welcome Back</h2><p class="auth-subtitle">Log in to your collaboration hub</p></div><form id="loginForm"><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" placeholder="alex@example.com" value="alex@example.com" required></div><div class="form-group"><label class="form-label">Password</label><div class="password-input-wrapper"><input type="password" class="form-input" placeholder="••••••••" value="password123" required><button type="button" class="password-toggle">👁️</button></div></div><button type="submit" class="btn btn-primary">Log In</button></form><div class="auth-switch">Don't have an account? <a href="#" class="auth-link" id="showRegister">Sign up</a></div></div>`;
            G.registerScreen.innerHTML = `<div class="auth-card"><div class="auth-header"><div class="logo"><div class="logo-icon">A</div>Among'sus</div><h2 class="auth-title">Join the Crew</h2><p class="auth-subtitle">Create an account to start collaborating</p></div><form id="registerForm"><div class="form-group"><label class="form-label">Full Name</label><input type="text" class="form-input" required></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" required></div><div class="form-group"><label class="form-label">Password</label><div class="password-input-wrapper"><input type="password" class="form-input" required><button type="button" class="password-toggle">👁️</button></div></div><button type="submit" class="btn btn-primary">Create Account</button></form><div class="auth-switch">Already have an account? <a href="#" class="auth-link" id="showLogin">Log in</a></div></div>`;
            G.header.innerHTML = `<div class="logo"><div class="logo-icon">A</div>Among'sus</div><div class="user-menu"><div class="user-avatar"></div></div>`;
            G.userAvatar = G.header.querySelector('.user-avatar');
        }

        function setupEventListeners() {
            document.addEventListener('submit', e => {
                e.preventDefault();
                const form = e.target;
                if (form.id === 'loginForm') handleLogin(form);
                if (form.id === 'registerForm') handleRegister(form);
                if (form.id === 'createProjectForm') createProject(form);
                if (form.id === 'createTaskForm') createTask(form);
            });

            document.addEventListener('click', e => {
                const target = e.target;
                if (target.id === 'showRegister') showRegisterScreen();
                if (target.id === 'showLogin') showLoginScreen();
                if (target.closest('.logo')) loadModalAndShow('secretModal');
                if (target.closest('.user-avatar')) loadModalAndShow('profileModal');
                if (target.id === 'logoutBtn') logout();
                if (target.id === 'saveProfileBtn') handleProfileUpdate();
                if (target.id === 'createProjectBtn') loadModalAndShow('createProjectModal');
                if (target.closest('.project-card')) showProjectView(target.closest('.project-card').dataset.projectId);
                if (target.id === 'backToProjects') showDashboard();
                if (target.id === 'createTaskBtn') loadModalAndShow('createTaskModal');
                if (target.id === 'viewTeamBtn') loadModalAndShow('teamModal');
                if (target.id === 'viewFigmaBtn') loadModalAndShow('figmaModal');
                if (target.closest('.chat-btn')) loadModalAndShow('chatModal');
                if (target.id === 'sendChatBtn') showNotification('Chat is a demo feature for now!', 'info');
                if (target.id === 'loadFigmaBtn') handleFigmaLoad();
                if (target.matches('.password-toggle')) togglePasswordVisibility(e);
                if (target.matches('.close-btn') || target.classList.contains('modal')) hideAllModals();
            });
            
            document.addEventListener('change', e => { if (e.target.id === 'avatarInput') handleAvatarUpload(e); });
            
            document.addEventListener('dragstart', e => { if (e.target.classList.contains('task-card')) e.target.classList.add('dragging'); });
            document.addEventListener('dragend', e => { if (e.target.classList.contains('task-card')) { e.target.classList.remove('dragging'); updateTaskStatus(e.target.dataset.taskId, e.target.closest('.task-column').id); } });
            document.addEventListener('dragover', e => { if (e.target.closest('.tasks-container')) { e.preventDefault(); e.target.closest('.tasks-container').appendChild(document.querySelector('.dragging')); } });
        }
        
        // --- AUTH & PROFILE ---
        function handleLogin(form) { const email = form.querySelector('input[type="email"]').value; const password = form.querySelector('input[type="password"]').value; const user = (JSON.parse(localStorage.getItem('users')) || []).find(u => u.email === email && u.password === password); if (user) { currentUser = user; localStorage.setItem('currentUser', JSON.stringify(user)); showMainApp(); showNotification(`Welcome back, ${user.name.split(' ')[0]}!`, 'success'); } else { showNotification('Invalid email or password', 'error'); } }
        function handleRegister(form) { const name = form.querySelector('input[type="text"]').value; const email = form.querySelector('input[type="email"]').value; const password = form.querySelector('input[type="password"]').value; const users = JSON.parse(localStorage.getItem('users') || '[]'); if (users.find(u => u.email === email)) { showNotification('User already exists', 'error'); return; } const newUser = { id: Date.now().toString(), name, email, password, avatar: null }; users.push(newUser); localStorage.setItem('users', JSON.stringify(users)); currentUser = newUser; localStorage.setItem('currentUser', JSON.stringify(newUser)); showMainApp(); showNotification('Account created successfully!', 'success'); }
        function logout() { currentUser = null; localStorage.removeItem('currentUser'); showLoginScreen(); hideAllModals(); showNotification('Logged out successfully', 'success'); }
        function handleProfileUpdate() { const newName = document.getElementById('profileName').value.trim(); if (!newName) { showNotification('Name cannot be empty.', 'error'); return; } currentUser.name = newName; updateCurrentUserStorage(); updateUserAvatar(); showNotification('Profile updated!', 'success'); hideAllModals(); }
        function handleAvatarUpload(e) { const file = e.target.files[0]; if (!file) return; if (file.size > 2 * 1024 * 1024) { showNotification('Image must be less than 2MB.', 'error'); return; } const reader = new FileReader(); reader.onload = function(event) { currentUser.avatar = event.target.result; updateCurrentUserStorage(); updateUserAvatar(); showNotification('Profile picture updated!', 'success'); }; reader.readAsDataURL(file); }

        // --- CORE APP LOGIC ---
        function createProject(form) { const name = form.querySelector('input[type="text"]').value; const newProject = { id: Date.now().toString(), name, ownerId: currentUser.id, members: [currentUser.id], figmaLink: null }; projects.push(newProject); saveProjectsToStorage(); renderProjects(); hideAllModals(); }
        function createTask(form) { const title = form.querySelector('input[type="text"]').value; const assigneeId = form.querySelector('#taskAssignee').value; const dueDate = form.querySelector('input[type="date"]').value; const newTask = { id: Date.now().toString(), title, assigneeId, dueDate, status: 'todo', projectId: currentProject.id }; tasks.push(newTask); saveTasksToStorage(); renderProjectTasks(); hideAllModals(); }
        function updateTaskStatus(taskId, newStatus) { const taskIndex = tasks.findIndex(t => t.id === taskId); if (taskIndex !== -1) { tasks[taskIndex].status = newStatus; saveTasksToStorage(); renderProjectTasks(); showNotification('Task moved!', 'success'); } }
        function handleFigmaLoad() { const input = document.getElementById('figmaLinkInput'); const container = document.getElementById('figmaEmbedContainer'); const url = input.value.trim(); if (url.startsWith('https://www.figma.com/file/')) { const embedUrl = `https://www.figma.com/embed?embed_host=share&url=${encodeURIComponent(url)}`; container.innerHTML = `<iframe src="${embedUrl}" allowfullscreen></iframe>`; currentProject.figmaLink = url; saveProjectsToStorage(); } else { container.innerHTML = `<p>Invalid Figma file link.</p>`; } }

        // --- RENDER & DISPLAY ---
        function switchScreen(activeScreen) { [G.loginScreen, G.registerScreen, G.mainApp].forEach(s => s.classList.add('hidden')); activeScreen.classList.remove('hidden'); }
        function showLoginScreen() { switchScreen(G.loginScreen); }
        function showRegisterScreen() { switchScreen(G.registerScreen); }
        function showMainApp() { switchScreen(G.mainApp); updateUserAvatar(); showDashboard(); }
        function showDashboard() { G.dashboard.classList.remove('hidden'); G.projectView.classList.add('hidden'); renderMyTasks(); renderProjects(); }
        function showProjectView(projectId) { currentProject = projects.find(p => p.id === projectId); if (!currentProject) return; G.dashboard.classList.add('hidden'); G.projectView.classList.remove('hidden'); G.projectTitle.textContent = currentProject.name; renderProjectTasks(); }
        function loadModalAndShow(modalId) { loadModalContent(modalId); document.getElementById(modalId).classList.add('show'); }
        function hideAllModals() { document.querySelectorAll('.modal.show').forEach(m => m.classList.remove('show')); }
        function renderMyTasks() { const myTasks = tasks.filter(t => t.assigneeId === currentUser.id && t.status !== 'done'); G.myTasksGrid.innerHTML = myTasks.length ? myTasks.map(task => { const project = projects.find(p => p.id === task.projectId); return `<div class="task-card ${task.status}"><div class="task-title">${task.title}</div><div class="task-meta"><span class="project-name-label">${project?.name || '...'}</span><span>${new Date(task.dueDate).toLocaleDateString()}</span></div></div>`; }).join('') : `<p style="color:var(--text-secondary)">You have no pending tasks. Great job!</p>`; }
        function renderProjects() { const userProjects = projects.filter(p => p.members.includes(currentUser.id)); G.projectsGrid.innerHTML = userProjects.length ? userProjects.map(project => { const pTasks = tasks.filter(t => t.projectId === project.id); const completed = pTasks.filter(t => t.status === 'done').length; const progress = pTasks.length ? (completed / pTasks.length) * 100 : 0; return `<div class="project-card" data-project-id="${project.id}"><div class="project-header"><h3 class="project-name">${project.name}</h3></div><div class="project-footer"><div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div></div></div>`; }).join('') : `<p style="color:var(--text-secondary); grid-column: 1 / -1; text-align: center;">No projects yet. Create one!</p>`; }
        function renderProjectTasks() { if (!currentProject) return; const pTasks = tasks.filter(t => t.projectId === currentProject.id); const columns = { todo: [], 'in-progress': [], done: [] }; pTasks.forEach(t => columns[t.status].push(t)); ['todo', 'in-progress', 'done'].forEach(status => { document.getElementById(`${status}Tasks`).innerHTML = renderTasksHTML(columns[status]); document.getElementById(`${status}Count`).textContent = columns[status].length; }); }
        function renderTasksHTML(taskList) { return taskList.length ? taskList.map(task => `<div class="task-card ${task.status}" draggable="true" data-task-id="${task.id}"><div class="task-title">${task.title}</div><div class="task-meta"><span>${(getUserById(task.assigneeId)?.name) || 'Unassigned'}</span><span>${new Date(task.dueDate).toLocaleDateString()}</span></div></div>`).join('') : `<p style="text-align:center; color:var(--text-secondary); padding: 1rem;">No tasks</p>`; }
        function loadModalContent(modalId) { const modal = document.getElementById(modalId); let content = ''; switch(modalId) { case 'profileModal': content = `<div class="modal-content"><div class="modal-header"><h3 class="modal-title">Profile & Settings</h3><button class="close-btn">&times;</button></div><div class="profile-pic-section"><div class="avatar-preview" id="avatarPreview"></div><div><input type="file" id="avatarInput" accept="image/*"><label for="avatarInput" class="btn btn-secondary" style="width:auto;">Change Picture</label></div></div><div class="form-group"><label class="form-label">Full Name</label><input type="text" class="form-input" id="profileName" value="${currentUser.name}"></div><div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="profileEmail" value="${currentUser.email}" readonly></div><div style="display:flex; gap:1rem; margin-top: 1rem;"><button class="btn btn-secondary" id="logoutBtn">Logout</button><button class="btn btn-primary" id="saveProfileBtn">Save Changes</button></div></div>`; break; case 'createProjectModal': content = `<div class="modal-content"><div class="modal-header"><h3 class="modal-title">New Project</h3><button class="close-btn">&times;</button></div><form id="createProjectForm"><div class="form-group"><label class="form-label">Project Name</label><input type="text" class="form-input" required></div><button type="submit" class="btn btn-primary">Create</button></form></div>`; break; case 'createTaskModal': content = `<div class="modal-content"><div class="modal-header"><h3 class="modal-title">New Task</h3><button class="close-btn">&times;</button></div><form id="createTaskForm"><div class="form-group"><label class="form-label">Task Title</label><input type="text" class="form-input" required></div><div class="form-group"><label class="form-label">Assignee</label><select class="form-input" id="taskAssignee" required></select></div><div class="form-group"><label class="form-label">Due Date</label><input type="date" class="form-input" required></div><button type="submit" class="btn btn-primary">Create Task</button></form></div>`; break; case 'teamModal': const membersHTML = currentProject.members.map(id => { const m = getUserById(id); return `<li class="team-member-item"><div class="member-avatar" style="${m.avatar ? `background-image:url(${m.avatar})` : ''}">${m.avatar ? '' : getInitials(m.name)}</div><div class="team-member-info"><strong>${m.name}</strong><span>${currentProject.ownerId === id ? 'Owner' : 'Member'}</span></div><button class="btn btn-secondary chat-btn" style="width:auto; padding: 0.4rem 0.8rem;">Chat</button></li>`; }).join(''); content = `<div class="modal-content"><div class="modal-header"><h3 class="modal-title">${currentProject.name} Team</h3><button class="close-btn">&times;</button></div><ul class="team-member-list">${membersHTML}</ul></div>`; break; case 'chatModal': content = `<div class="modal-content" style="max-width: 800px; height: 80vh; display:flex; flex-direction: column; padding:0;"><div class="chat-header"><h3>Chat (UI Demo)</h3><button class="close-btn">&times;</button></div><div style="flex-grow:1; padding: 1rem; overflow-y:auto;"></div><div style="padding: 1rem; border-top: 1px solid var(--border-color); display:flex; gap:1rem;"><input type="text" class="form-input" placeholder="Chat is a demo feature..."><button class="btn btn-primary" id="sendChatBtn">Send</button></div></div>`; break; case 'figmaModal': content = `<div class="modal-content" style="max-width: 90vw;"><div class="modal-header"><h3 class="modal-title">Figma Designs</h3><button class="close-btn">&times;</button></div><div style="display:flex; gap:1rem;"><input type="text" class="form-input" id="figmaLinkInput" placeholder="Paste public Figma link..."><button class="btn btn-primary" id="loadFigmaBtn" style="width:auto;">Load</button></div><div id="figmaEmbedContainer"><p>Load a design to view it here.</p></div></div>`; break; case 'secretModal': const secretText = `Maybe I\nLost my mind\nNo one noticed\nNo one noticed\n\nIt's getting old (I'd kinda like it if you'd call me)\nAll alone ('cause I'm so over bein' lonely)\nMay have lost it (I need a virtual connection)\nI have lost it (be my video obsession)\n\nNo one tried\nTo read my eyes\nNo one but you\nWish it weren't true\n\nMaybe I (I'd kinda like it if you'd call me)\nIt's not right ('cause I'm so over being lonely)\nMake you mine (I need a virtual connection)\nTake our time (be my video obsession)\n\nCome on, don't leave me it can't be that easy, babe \nIf you believe me I guess I'll get on a plane \nFly to your city excited to see your face \nHold me, console me and then I'll leave without a trace`; content=`<div class="modal-content" id="secretModal"><div class="modal-header"><h3 class="modal-title">A Transmission...</h3><button class="close-btn">&times;</button></div><pre>${secretText}</pre></div>`; break; } modal.innerHTML = content; if (modal.id === 'profileModal' || modal.id === 'teamModal') { updateUserAvatar(); } if (modal.id === 'createTaskModal') { populateTaskAssignees(); } }
        
        // --- UTILITIES & DATA ---
        function updateUserAvatar() { const elements = [G.userAvatar, document.getElementById('avatarPreview')].filter(Boolean); elements.forEach(el => { if (currentUser?.avatar) { el.style.backgroundImage = `url(${currentUser.avatar})`; el.textContent = ''; } else { el.style.backgroundImage = 'none'; el.textContent = getInitials(currentUser?.name); } }); }
        function getInitials(name = '') { return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) || 'U'; }
        function getUserById(id) { return (JSON.parse(localStorage.getItem('users')) || []).find(u => u.id === id); }
        function showNotification(message, type = 'success') { const n = document.createElement('div'); n.className = `notification ${type}`; n.textContent = message; document.body.appendChild(n); setTimeout(() => n.remove(), 3000); }
        function togglePasswordVisibility(e) { const input = e.target.previousElementSibling; const type = input.type === 'password' ? 'text' : 'password'; input.type = type; e.target.textContent = type === 'password' ? '👁️' : '🙈'; }
        function loadUserData() { projects = JSON.parse(localStorage.getItem('projects') || '[]'); tasks = JSON.parse(localStorage.getItem('tasks') || '[]'); }
        function saveProjectsToStorage() { localStorage.setItem('projects', JSON.stringify(projects)); }
        function saveTasksToStorage() { localStorage.setItem('tasks', JSON.stringify(tasks)); }
        function updateCurrentUserStorage() { localStorage.setItem('currentUser', JSON.stringify(currentUser)); const users = JSON.parse(localStorage.getItem('users') || '[]'); const userIndex = users.findIndex(u => u.id === currentUser.id); if (userIndex !== -1) { users[userIndex] = currentUser; localStorage.setItem('users', JSON.stringify(users)); } }
        function loadSampleData() { localStorage.setItem('users', JSON.stringify([{ id: 'user1', name: 'Alex Rivera', email: 'alex@example.com', password: 'password123', avatar: null }, { id: 'user2', name: 'Bella Chen', email: 'bella@example.com', password: 'password123', avatar: null }])); localStorage.setItem('projects', JSON.stringify([{ id: 'proj1', name: 'Website Redesign', ownerId: 'user1', members: ['user1', 'user2'], figmaLink: 'https://www.figma.com/file/LKQ4FJ4bTnbykzze12dgh4/Default-Project-File'}])); localStorage.setItem('tasks', JSON.stringify([{ id: 'task1', title: 'Design Homepage Mockup', assigneeId: 'user2', dueDate: '2025-10-15', status: 'in-progress', projectId: 'proj1' }, { id: 'task2', title: 'Setup Dev Environment', assigneeId: 'user1', dueDate: '2025-10-10', status: 'done', projectId: 'proj1' }, { id: 'task3', title: 'Plan Auth Flow', assigneeId: 'user1', dueDate: '2025-10-20', status: 'todo', projectId: 'proj1' }])); localStorage.setItem('sampleDataLoaded', 'true'); }
        function populateTaskAssignees() { const select = document.getElementById('taskAssignee'); select.innerHTML = currentProject.members.map(id => { const m = getUserById(id); return `<option value="${m.id}">${m.name}</option>` }).join(''); }

        initializeApp();
    });
    </script>
</body>
</html>